rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ALIGNIFY FITNESS APP - SECURITY RULES
    // ============================================
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function validTimestamp() {
      return request.resource.data.timestamp is timestamp || 
             request.resource.data.timestamp is number;
    }
    
    // ============================================
    // USER DATA
    // ============================================
    
    match /users/{userId} {
      // Users can only read/write their own document
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // Never allow user deletion via client
      
      // ----------------------------------------
      // WORKOUT SESSIONS
      // ----------------------------------------
      match /workouts/{workoutId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validFields();
        allow update: if false; // Workouts are immutable
        allow delete: if false; // Workouts cannot be deleted
        
        function validFields() {
          return request.resource.data.keys().hasAll(['exercise', 'reps', 'duration', 'timestamp']);
        }
      }
      
      // ----------------------------------------
      // DAILY STATS (Aggregated)
      // ----------------------------------------
      match /dailyStats/{date} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
      
      // ----------------------------------------
      // EXERCISE STATS (Per-exercise progress)
      // ----------------------------------------
      match /exerciseProgress/{exerciseId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // ============================================
    // DENORMALIZED EXERCISE STATS (V2)
    // ============================================
    
    match /exerciseStats/{docId} {
      // Document ID format: {userId}_{exerciseId}
      allow read, write: if isAuthenticated() && 
                           docId.matches(request.auth.uid + '_.*');
    }
    
    // ============================================
    // GLOBAL EXERCISE CATALOG (Read-only)
    // ============================================
    
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin-only via Firebase Console
    }
    
    // ============================================
    // ACHIEVEMENTS CATALOG (Read-only)
    // ============================================
    
    match /achievements/{achievementId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin-only
    }
    
    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
